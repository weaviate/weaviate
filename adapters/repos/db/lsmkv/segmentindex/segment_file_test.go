//                           _       _
// __      _____  __ ___   ___  __ _| |_ ___
// \ \ /\ / / _ \/ _` \ \ / / |/ _` | __/ _ \
//  \ V  V /  __/ (_| |\ V /| | (_| | ||  __/
//   \_/\_/ \___|\__,_| \_/ |_|\__,_|\__\___|
//
//  Copyright Â© 2016 - 2024 Weaviate B.V. All rights reserved.
//
//  CONTACT: hello@weaviate.io
//

package segmentindex

import (
	"fmt"
	"os"
	"path"
	"testing"

	"github.com/stretchr/testify/require"
)

// contentsWithChecksum is a precomputed segment file from the property__id bucket.
// The data object which was used to generate this segment file is the following:
//
//	{
//	  "id": "3722dfe8-b26c-4d05-95ee-41045673b43d",
//	  "class": "Paragraph",
//	  "properties": {
//	    "contents": "para1"
//	    }
//	}
//
// These contents include the CRC32 checksum which was calculated based on the:
//   - segment data
//   - segment indexes
//   - segment header
//
// The checksum is calculated using those components in that exact ordering.
// This is because during compactions, the header is not actually known until
// the compaction process is complete. So to accommodate this, all segment
// checksum calculations are made using the header last.
var contentsWithChecksum = []byte{
	0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x01, 0x00, 0x51, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x01, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x08, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0x24, 0x00, 0x00, 0x00, 0x33, 0x37, 0x32,
	0x32, 0x64, 0x66, 0x65, 0x38, 0x2d, 0x62, 0x32, 0x36, 0x63, 0x2d, 0x34,
	0x64, 0x30, 0x35, 0x2d, 0x39, 0x35, 0x65, 0x65, 0x2d, 0x34, 0x31, 0x30,
	0x34, 0x35, 0x36, 0x37, 0x33, 0x62, 0x34, 0x33, 0x64, 0x24, 0x00, 0x00,
	0x00, 0x33, 0x37, 0x32, 0x32, 0x64, 0x66, 0x65, 0x38, 0x2d, 0x62, 0x32,
	0x36, 0x63, 0x2d, 0x34, 0x64, 0x30, 0x35, 0x2d, 0x39, 0x35, 0x65, 0x65,
	0x2d, 0x34, 0x31, 0x30, 0x34, 0x35, 0x36, 0x37, 0x33, 0x62, 0x34, 0x33,
	0x64, 0x10, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x00, 0x51, 0x00, 0x00,
	0x00, 0x00, 0x00, 0x00, 0x00, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff,
	0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0xff, 0x53, 0x4c, 0x67,
	0x5a,
}

func TestSegmentFile_ValidateChecksum(t *testing.T) {
	dir := t.TempDir()
	fname := path.Join(dir, "tmp.db")

	{
		// setup
		f, err := os.Create(fname)
		require.Nil(t, err)
		_, err = f.Write(contentsWithChecksum)
		require.Nil(t, err)
		f.Close()
	}

	f, err := os.Open(fname)
	require.Nil(t, err)
	defer f.Close()

	fileInfo, err := f.Stat()
	if err != nil {
		fmt.Printf("Error getting file info: %v\n", err)
		return
	}

	segmentFile := NewSegmentFile(WithReader(f))
	err = segmentFile.ValidateChecksum(fileInfo.Size())
	require.Nil(t, err)
}
