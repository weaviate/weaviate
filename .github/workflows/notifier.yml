name: Notify Slack on PR (Non-Member) or Any Issue

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Check if actor is a non-member (for PRs only)
        if: github.event_name == 'pull_request'
        id: check_user
        uses: actions/github-script@v7
        with:
          script: |
            const { actor, repo, owner } = context;
            const result = await github.rest.orgs.checkMembershipForUser({
              org: owner,
              username: actor
            }).catch(() => ({ status: 404 }));

            if (result.status === 404) {
              core.setOutput('is_non_member', 'true');
            } else {
              core.setOutput('is_non_member', 'false');
            }

      - name: Send Slack Notification for PR (Non-Member)
        if: github.event_name == 'pull_request' && steps.check_user.outputs.is_non_member == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_ACTOR: ${{ github.actor }}
          PR_URL: ${{ github.event.pull_request.html_url }}
          PR_TITLE: ${{ github.event.pull_request.title }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "ðŸš¨ A Pull Request has been opened by a *non-member*:\n*User:* $GITHUB_ACTOR\n*Title:* $PR_TITLE\n*Link:* $PR_URL"
          }' $SLACK_WEBHOOK_URL

      - name: Send Slack Notification for All Issues
        if: github.event_name == 'issues'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
          GITHUB_ACTOR: ${{ github.actor }}
          ISSUE_URL: ${{ github.event.issue.html_url }}
          ISSUE_TITLE: ${{ github.event.issue.title }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "ðŸ“¢ A new Issue has been opened:\n*User:* $GITHUB_ACTOR\n*Title:* $ISSUE_TITLE\n*Link:* $ISSUE_URL"
          }' $SLACK_WEBHOOK_URL
