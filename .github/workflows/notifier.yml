name: Notify Slack on PR (Non-Member) or Any Issue

on:
  issues:
    types: [opened]
  pull_request:
    types: [opened]

jobs:
  notify-slack:
    runs-on: ubuntu-latest

    steps:
      - name: Check if actor is a non-member (for PRs only)
        if: github.event_name == 'pull_request'
        id: check_user
        uses: actions/github-script@v7
        with:
          github-token: ${{ secrets.GITHUB_TOKEN }}
          script: |
            const org = context.repo.owner;
            const team_slug = "weaviate";
            const username = context.actor;

            try {
              const response = await github.rest.teams.getMembershipForUserInOrg({
                org: org,
                team_slug: team_slug,
                username: username
              });

              if (response.status === 200 && response.data.state === "active") {
                core.info(`${username} is an active member of team ${team_slug}.`);
                core.setOutput('is_team_member', 'true');
              } else {
                core.info(`${username} is not an active member of team ${team_slug}.`);
                core.setOutput('is_team_member', 'false');
              }
            } catch (error) {
              if (error.status === 404) {
                core.info(`${username} is NOT a member of team ${team_slug}.`);
                core.setOutput('is_team_member', 'false');
              } else {
                core.error(`Error checking team membership: ${error.message}`);
                core.setOutput('is_team_member', 'unknown');
              }
            }

      - name: Send Slack Notification for PR (Community)
        if: github.event_name == 'pull_request' && steps.check_user.outputs.is_non_member == 'true'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "ðŸ“¢ A Pull Request has been opened by a *community*:\n*User:* ${{ github.actor }}\n*Title:* ${{ github.event.pull_request.title }}\n*Link:* ${{ github.event.pull_request.html_url }}"
          }' $SLACK_WEBHOOK_URL

      - name: Send Slack Notification for All Issues
        if: github.event_name == 'issues'
        env:
          SLACK_WEBHOOK_URL: ${{ secrets.SLACK_WEBHOOK_URL }}
        run: |
          curl -X POST -H 'Content-type: application/json' --data '{
            "text": "ðŸš¨ A new Issue has been opened:\n*User:* ${{ github.actor }}\n*Title:* ${{ github.event.issue.title }}\n*Link:* ${{ github.event.issue.html_url }}"
          }' $SLACK_WEBHOOK_URL
